var gdjs;(function(l){const v=class extends l.RuntimeBehavior{constructor(e,t,s){super(e,t,s);this._physics3D=null;this._isHookedToPhysicsStep=!1;this.character=null;this._destroyedDuringFrameLogic=!1;this._slopeClimbingFactor=1;this._slopeClimbingMinNormalZ=Math.cos(Math.PI/4);this._forwardAngle=0;this._hasPressedForwardKey=!1;this._hasPressedBackwardKey=!1;this._hasPressedRightKey=!1;this._hasPressedLeftKey=!1;this._hasPressedJumpKey=!1;this._hasUsedStick=!1;this._stickAngle=0;this._stickForce=0;this._currentForwardSpeed=0;this._currentSidewaysSpeed=0;this._currentFallSpeed=0;this._canJump=!1;this._currentJumpSpeed=0;this._timeSinceCurrentJumpStart=0;this._jumpKeyHeldSinceJumpStart=!1;this._hasReallyMoved=!1;this._oldPhysicsPosition=[0,0];this._wasLeftKeyPressed=!1;this._wasRightKeyPressed=!1;this._wasForwardKeyPressed=!1;this._wasBackwardKeyPressed=!1;this._wasJumpKeyPressed=!1;this._wasStickUsed=!1;this._clearInputsBetweenFrames=!0;this.owner3D=s,this._physics3DBehaviorName=t.physics3D,this._sharedData=l.Physics3DSharedData.getSharedData(e.getScene(),t.Physics3D),this.collisionChecker=new l.PhysicsCharacter3DRuntimeBehavior.CharacterCollisionChecker(this),this.charactersManager=l.PhysicsCharacter3DRuntimeBehavior.CharactersManager.getManager(e),this._slopeMaxAngle=0,this.setSlopeMaxAngle(t.slopeMaxAngle),this._forwardAcceleration=t.forwardAcceleration,this._forwardDeceleration=t.forwardDeceleration,this._forwardSpeedMax=t.forwardSpeedMax,this._sidewaysAcceleration=t.sidewaysAcceleration,this._sidewaysDeceleration=t.sidewaysDeceleration,this._sidewaysSpeedMax=t.sidewaysSpeedMax,this._gravity=t.gravity,this._maxFallingSpeed=t.fallingSpeedMax,this._jumpSustainTime=t.jumpSustainTime,this._jumpSpeed=this.getJumpSpeedToReach(t.jumpHeight),this._shouldBindObjectAndForwardAngle=t.shouldBindObjectAndForwardAngle,this._stairHeightMax=t.stairHeightMax===void 0?20:t.stairHeightMax,this._canBePushed=t.canBePushed===void 0?!0:t.canBePushed}getVec3(e,t,s){const o=this._sharedData._tempVec3;return o.Set(e,t,s),o}getPhysics3D(){if(this._destroyedDuringFrameLogic)return null;if(this._physics3D)return this._physics3D;if(!this.activated())return null;const e=this.owner.getBehavior(this._physics3DBehaviorName);if(!e.activated())return null;const t=e._sharedData,s=t.jolt,o=new Jolt.ExtendedUpdateSettings,a=new Jolt.DefaultBroadPhaseLayerFilter(s.GetObjectVsBroadPhaseLayerFilter(),l.Physics3DSharedData.dynamicBroadPhaseLayerIndex),r=new Jolt.DefaultObjectLayerFilter(s.GetObjectLayerPairFilter(),e.getBodyLayer()),i=new Jolt.BodyFilter,h=new Jolt.ShapeFilter;this._physics3D={behavior:e,extendedUpdateSettings:o,broadPhaseLayerFilter:a,objectLayerFilter:r,bodyFilter:i,shapeFilter:h},this.setStairHeightMax(this._stairHeightMax),this._isHookedToPhysicsStep||(t.registerHook(this),this._isHookedToPhysicsStep=!0);let c={linearVelocityX:0,linearVelocityY:0,linearVelocityZ:0,angularVelocityX:0,angularVelocityY:0,angularVelocityZ:0};if(e._body){const n=e._body.GetLinearVelocity();c.linearVelocityX=n.GetX(),c.linearVelocityY=n.GetY(),c.linearVelocityZ=n.GetZ();const d=e._body.GetAngularVelocity();c.angularVelocityX=d.GetX(),c.angularVelocityY=d.GetY(),c.angularVelocityZ=d.GetZ(),e.bodyUpdater.destroyBody()}return e.bodyUpdater=new l.PhysicsCharacter3DRuntimeBehavior.CharacterBodyUpdater(this),e.collisionChecker=this.collisionChecker,e.recreateBody(c),this._forwardAngle=this.owner.getAngle(),this._physics3D}updateFromBehaviorData(e,t){return e.gravity!==t.gravity&&this.setGravity(t.gravity),e.maxFallingSpeed!==t.maxFallingSpeed&&this.setMaxFallingSpeed(t.maxFallingSpeed),e.forwardAcceleration!==t.forwardAcceleration&&this.setForwardAcceleration(t.forwardAcceleration),e.forwardDeceleration!==t.forwardDeceleration&&this.setForwardDeceleration(t.forwardDeceleration),e.forwardSpeedMax!==t.forwardSpeedMax&&this.setForwardSpeedMax(t.forwardSpeedMax),e.sidewaysAcceleration!==t.sidewaysAcceleration&&this.setSidewaysAcceleration(t.sidewaysAcceleration),e.sidewaysDeceleration!==t.sidewaysDeceleration&&this.setSidewaysDeceleration(t.sidewaysDeceleration),e.sidewaysSpeedMax!==t.sidewaysSpeedMax&&this.setSidewaysSpeedMax(t.sidewaysSpeedMax),e.jumpSustainTime!==t.jumpSustainTime&&this.setJumpSustainTime(t.jumpSustainTime),e.jumpHeight!==t.jumpHeight&&this.setJumpSpeed(this.getJumpSpeedToReach(t.jumpHeight)),e.shouldBindObjectAndForwardAngle!==t.shouldBindObjectAndForwardAngle&&this.setShouldBindObjectAndForwardAngle(t.shouldBindObjectAndForwardAngle),e.stairHeightMax!==t.stairHeightMax&&this.setStairHeightMax(t.stairHeightMax),!0}getNetworkSyncData(e){return this._clearInputsBetweenFrames=!0,{...super.getNetworkSyncData(e),props:{sma:this._slopeMaxAngle,shm:this._stairHeightMax,grav:this._gravity,mfs:this._maxFallingSpeed,facc:this._forwardAcceleration,fdec:this._forwardDeceleration,fsm:this._forwardSpeedMax,sacc:this._sidewaysAcceleration,sdec:this._sidewaysDeceleration,ssm:this._sidewaysSpeedMax,jumpspeed:this._jumpSpeed,jumpsustime:this._jumpSustainTime,fwa:this._forwardAngle,sbpa:this._shouldBindObjectAndForwardAngle,fws:this._currentForwardSpeed,sws:this._currentSidewaysSpeed,cfs:this._currentFallSpeed,cjs:this._currentJumpSpeed,cj:this._canJump,lek:this._wasLeftKeyPressed,rik:this._wasRightKeyPressed,upk:this._wasForwardKeyPressed,dok:this._wasBackwardKeyPressed,juk:this._wasJumpKeyPressed,us:this._wasStickUsed,sa:this._stickAngle,sf:this._stickForce,tscjs:this._timeSinceCurrentJumpStart,jkhsjs:this._jumpKeyHeldSinceJumpStart}}}updateFromNetworkSyncData(e,t){super.updateFromNetworkSyncData(e,t);const s=e.props;this._slopeMaxAngle=s.sma,this._stairHeightMax=s.shm,this._gravity=s.grav,this._maxFallingSpeed=s.mfs,this._forwardAcceleration=s.facc,this._forwardDeceleration=s.fdec,this._forwardSpeedMax=s.fsm,this._sidewaysAcceleration=s.sacc,this._sidewaysDeceleration=s.sdec,this._sidewaysSpeedMax=s.ssm,this._jumpSpeed=s.jumpspeed,this._jumpSustainTime=s.jumpsustime,this._forwardAngle=s.fwa,this._shouldBindObjectAndForwardAngle=s.sbpa,this._currentForwardSpeed=s.fws,this._currentSidewaysSpeed=s.sws,this._currentFallSpeed=s.cfs,this._currentJumpSpeed=s.cjs,this._canJump=s.cj,this._hasPressedForwardKey=s.upk,this._hasPressedBackwardKey=s.dok,this._hasPressedLeftKey=s.lek,this._hasPressedRightKey=s.rik,this._hasPressedJumpKey=s.juk,this._hasUsedStick=s.us,this._stickAngle=s.sa,this._stickForce=s.sf,this._timeSinceCurrentJumpStart=s.tscjs,this._jumpKeyHeldSinceJumpStart=s.jkhsjs,this._clearInputsBetweenFrames=!!t.clearInputs}_getPhysicsPosition(e){const t=this.getPhysics3D();if(!t)return e.Set(0,0,0),e;const{behavior:s}=t;return e.Set(this.owner3D.getCenterXInScene()*this._sharedData.worldInvScale,this.owner3D.getCenterYInScene()*this._sharedData.worldInvScale,this.owner3D.getZ()*this._sharedData.worldInvScale+s._shapeHalfDepth),e}_getPhysicsRotation(e){const t=e.sEulerAngles(this.getVec3(0,0,l.toRad(this.owner3D.getAngle())));return e.Set(t.GetX(),t.GetY(),t.GetZ(),t.GetW()),Jolt.destroy(t),e}_moveObjectToPhysicsPosition(e){const t=this.getPhysics3D();if(!t)return;const{behavior:s}=t;this.owner3D.setCenterXInScene(e.GetX()*this._sharedData.worldScale),this.owner3D.setCenterYInScene(e.GetY()*this._sharedData.worldScale),this.owner3D.setZ((e.GetZ()-s._shapeHalfDepth)*this._sharedData.worldScale)}_moveObjectToPhysicsRotation(e){const t=this.owner3D.get3DRendererObject();t.quaternion.x=e.GetX(),t.quaternion.y=e.GetY(),t.quaternion.z=e.GetZ(),t.quaternion.w=e.GetW();const s=new THREE.Euler(0,0,0,"ZYX");s.setFromQuaternion(t.quaternion),this.owner3D.setAngle(l.toDegrees(s.z))}onDeActivate(){!this._physics3D||this._destroyBody()}onActivate(){const e=this.owner.getBehavior(this._physics3DBehaviorName);!e||e._destroyBody()}onDestroy(){this._destroyedDuringFrameLogic=!0,this.onDeActivate()}_destroyBody(){if(this.character&&(this._canBePushed&&(this.charactersManager.removeCharacter(this.character),Jolt.destroy(this.character.GetListener())),this.collisionChecker.clearContacts(),Jolt.destroy(this.character),this.character=null,this._physics3D)){const{behavior:e}=this._physics3D;e.resetToDefaultBodyUpdater(),e.resetToDefaultCollisionChecker(),this._physics3D.behavior._body=null;const{extendedUpdateSettings:t,broadPhaseLayerFilter:s,objectLayerFilter:o,bodyFilter:a,shapeFilter:r}=this._physics3D;Jolt.destroy(t),Jolt.destroy(s),Jolt.destroy(o),Jolt.destroy(a),Jolt.destroy(r),this._physics3D=null}}doStepPreEvents(e){this.getPhysics3D()}doStepPostEvents(e){this.getPhysics3D()}doBeforePhysicsStep(e){if(!this.activated())return;const t=this.getPhysics3D();if(!t)return;const{behavior:s,extendedUpdateSettings:o,broadPhaseLayerFilter:a,objectLayerFilter:r,bodyFilter:i,shapeFilter:h}=t;if(!this.character||!s._body)return;const n=this._sharedData.worldInvScale,d=this.character.GetPosition().GetX(),C=this.character.GetPosition().GetY(),m=this.character.GetPosition().GetZ();this._shouldBindObjectAndForwardAngle&&(this._forwardAngle=this.owner.getAngle()),this.updateCharacterSpeedFromInputs(e),this._currentJumpSpeed>0&&(this._timeSinceCurrentJumpStart+=e),this._hasPressedJumpKey||(this._jumpKeyHeldSinceJumpStart=!1),this._canJump&&this._hasPressedJumpKey&&!this._jumpKeyHeldSinceJumpStart&&(this._currentJumpSpeed=this._jumpSpeed,this._currentFallSpeed=0,this._canJump=!1,this._jumpKeyHeldSinceJumpStart=!0,this._timeSinceCurrentJumpStart=0),this.isOnFloor()||(this._jumpKeyHeldSinceJumpStart&&this._timeSinceCurrentJumpStart<this._jumpSustainTime||(this._currentJumpSpeed=Math.max(0,this._currentJumpSpeed-this._gravity*e)),this._currentFallSpeed=Math.min(this._maxFallingSpeed,this._currentFallSpeed+this._gravity*e));let F=0,M=0,A=0;if(this.character.IsSupported()&&this.updateGroundVelocity(s,e)){const f=this.character.GetGroundVelocity();F=f.GetX(),M=f.GetY(),A=f.GetZ()}let g=this._currentForwardSpeed,P=this._currentSidewaysSpeed;if(P!==0&&g!==0){const p=Math.hypot(g/this._forwardSpeedMax,P/this._sidewaysSpeedMax);p>1&&(g/=p,P/=p)}g*=n,P*=n;const u=l.toRad(this._forwardAngle),y=Math.cos(u),_=Math.sin(u),S=g*y-P*_,w=g*_+P*y;if(this.character.SetLinearVelocity(this.getVec3(F+S,M+w,(this._currentJumpSpeed-this._currentFallSpeed)*n)),this.isOnFloor()){const p=Math.max(Math.hypot(this.character.GetPosition().GetX()-this._oldPhysicsPosition[0],this.character.GetPosition().GetY()-this._oldPhysicsPosition[1]),Math.hypot(this.character.GetLinearVelocity().GetX(),this.character.GetLinearVelocity().GetY())*e);this._oldPhysicsPosition[0]=this.character.GetPosition().GetX(),this._oldPhysicsPosition[1]=this.character.GetPosition().GetY();const f=Math.max(-.01+1.01*Math.min(-p*this._slopeClimbingFactor,A*e),-this._maxFallingSpeed*n*e);o.mStickToFloorStepDown.Set(0,0,f)}else o.mStickToFloorStepDown.Set(0,0,0);this.character.ExtendedUpdate(e,this.character.GetUp(),o,a,r,i,h,this._sharedData.jolt.GetTempAllocator()),this.collisionChecker.updateContacts(),this.isOnFloor()&&(this._canJump=!0,this._currentFallSpeed=0,this._currentJumpSpeed=0),this._wasForwardKeyPressed=this._hasPressedForwardKey,this._wasBackwardKeyPressed=this._hasPressedBackwardKey,this._wasRightKeyPressed=this._hasPressedRightKey,this._wasLeftKeyPressed=this._hasPressedLeftKey,this._wasJumpKeyPressed=this._hasPressedJumpKey,this._wasStickUsed=this._hasUsedStick,this._clearInputsBetweenFrames&&(this._hasPressedForwardKey=!1,this._hasPressedBackwardKey=!1,this._hasPressedRightKey=!1,this._hasPressedLeftKey=!1,this._hasPressedJumpKey=!1,this._hasUsedStick=!1),this._hasReallyMoved=Math.abs(this.character.GetPosition().GetX()-d)>v.epsilon||Math.abs(this.character.GetPosition().GetY()-C)>v.epsilon||Math.abs(this.character.GetPosition().GetZ()-m)>v.epsilon}updateCharacterSpeedFromInputs(e){let t=0;this._hasPressedBackwardKey!==this._hasPressedForwardKey?this._hasPressedBackwardKey?t=-this._forwardSpeedMax:this._hasPressedForwardKey&&(t=this._forwardSpeedMax):this._hasUsedStick&&(t=-this._forwardSpeedMax*this._stickForce*Math.sin(l.toRad(this._stickAngle))),this._currentForwardSpeed=v.getAcceleratedSpeed(this._currentForwardSpeed,t,this._forwardSpeedMax,this._forwardAcceleration,this._forwardDeceleration,e);let s=0;this._hasPressedLeftKey!==this._hasPressedRightKey?this._hasPressedLeftKey?s=-this._sidewaysSpeedMax:this._hasPressedRightKey&&(s=this._sidewaysSpeedMax):this._hasUsedStick&&(s=this._sidewaysSpeedMax*this._stickForce*Math.cos(l.toRad(this._stickAngle))),this._currentSidewaysSpeed=v.getAcceleratedSpeed(this._currentSidewaysSpeed,s,this._sidewaysSpeedMax,this._sidewaysAcceleration,this._sidewaysDeceleration,e)}static getAcceleratedSpeed(e,t,s,o,a,r){let i=e;return t<0?e<=t?i=Math.min(t,e+a*r):e<=0?i-=Math.max(-s,o*r):i=Math.max(t,e-Math.max(o,a)*r):t>0?e>=t?i=Math.max(t,e-a*r):e>=0?i=Math.min(s,e+o*r):i=Math.min(t,e+Math.max(o,a)*r):(e<0&&(i=Math.min(e+a*r,0)),e>0&&(i=Math.max(e-a*r,0))),i}updateGroundVelocity(e,t){if(!this.character||!e._body)return!1;const o=this._sharedData.worldInvScale;if(!this.character.IsSupported())return!1;const a=this._sharedData.physicsSystem.GetBodyLockInterface().TryGetBody(this.character.GetGroundBodyID()),r=a.IsKinematic()&&a.GetLinearVelocity().Equals(Jolt.Vec3.prototype.sZero())&&a.GetAngularVelocity().Equals(Jolt.Vec3.prototype.sZero());if(r){const n=a.gdjsAssociatedBehavior;if(n){const d=1/t;a.SetLinearVelocity(this.getVec3((n.owner3D.getX()-n._objectOldX)*o*d,(n.owner3D.getY()-n._objectOldY)*o*d,(n.owner3D.getZ()-n._objectOldZ)*o*d)),a.SetAngularVelocity(this.getVec3(0,0,l.toRad(l.evtTools.common.angleDifference(n.owner3D.getAngle(),n._objectOldRotationZ))*d))}}this.character.UpdateGroundVelocity();const i=a.GetAngularVelocity().GetZ();if(i!==0){const n=i*t;this.character.SetRotation(Jolt.Quat.prototype.sEulerAngles(this.getVec3(0,0,this.character.GetRotation().GetRotationAngle(Jolt.Vec3.prototype.sAxisZ())+n))),this._forwardAngle+=l.toDegrees(n)}r&&(a.SetLinearVelocity(Jolt.Vec3.prototype.sZero()),a.SetAngularVelocity(Jolt.Vec3.prototype.sZero()));const h=1*Math.PI/180;return Math.abs(a.GetAngularVelocity().GetX())<h&&Math.abs(a.GetAngularVelocity().GetY())<h}onObjectHotReloaded(){}getSlopeMaxAngle(){return this._slopeMaxAngle}setSlopeMaxAngle(e){e<0||e>=90||(this._slopeMaxAngle=e,e===45?this._slopeClimbingFactor=1:this._slopeClimbingFactor=Math.max(1/1024,Math.tan(l.toRad(e))),this._slopeClimbingMinNormalZ=Math.min(Math.cos(l.toRad(e)),1-1/1024))}getStairHeightMax(){return this._stairHeightMax}setStairHeightMax(e){this._stairHeightMax=e;const t=this.getPhysics3D();if(!t)return;const{extendedUpdateSettings:s}=t,o=e*this._sharedData.worldInvScale;s.mWalkStairsStepUp=this.getVec3(0,0,o),s.mWalkStairsMinStepForward=.02/.4*o,s.mWalkStairsStepForwardTest=.15/.4*o}getGravity(){return this._gravity}setGravity(e){this._gravity=e}getMaxFallingSpeed(){return this._maxFallingSpeed}setMaxFallingSpeed(e,t=!1){if(t&&!this.isOnFloor()){const s=this._currentFallSpeed-e;s>0&&(this._currentFallSpeed-=s,this._currentJumpSpeed=Math.max(0,this.getCurrentJumpSpeed()-s))}this._maxFallingSpeed=e}getForwardAcceleration(){return this._forwardAcceleration}setForwardAcceleration(e){this._forwardAcceleration=e}getForwardDeceleration(){return this._forwardDeceleration}setForwardDeceleration(e){this._forwardDeceleration=e}getForwardSpeedMax(){return this._forwardSpeedMax}setForwardSpeedMax(e){this._forwardSpeedMax=e}getSidewaysAcceleration(){return this._sidewaysAcceleration}setSidewaysAcceleration(e){this._sidewaysAcceleration=e}getSidewaysDeceleration(){return this._sidewaysDeceleration}setSidewaysDeceleration(e){this._sidewaysDeceleration=e}getSidewaysSpeedMax(){return this._sidewaysSpeedMax}setSidewaysSpeedMax(e){this._sidewaysSpeedMax=e}getJumpSpeed(){return this._jumpSpeed}setJumpSpeed(e){this._jumpSpeed=e}getJumpSustainTime(){return this._jumpSustainTime}setJumpSustainTime(e){this._jumpSustainTime=e}getForwardAngle(){return this._forwardAngle}setForwardAngle(e){this._forwardAngle=e,this._shouldBindObjectAndForwardAngle&&this.owner.setAngle(e)}isForwardAngleAround(e,t){return Math.abs(l.evtTools.common.angleDifference(this._forwardAngle,e))<=t}shouldBindObjectAndForwardAngle(){return this._shouldBindObjectAndForwardAngle}setShouldBindObjectAndForwardAngle(e){this._shouldBindObjectAndForwardAngle=e}getCurrentForwardSpeed(){return this._currentForwardSpeed}setCurrentForwardSpeed(e){this._currentForwardSpeed=e}getCurrentSidewaysSpeed(){return this._currentSidewaysSpeed}setCurrentSidewaysSpeed(e){this._currentSidewaysSpeed=e}getCurrentFallSpeed(){return this._currentFallSpeed}setCurrentFallSpeed(e){this._currentFallSpeed=l.evtTools.common.clamp(e,0,this._maxFallingSpeed)}getCurrentJumpSpeed(){return this._currentJumpSpeed}setCurrentJumpSpeed(e){this._currentJumpSpeed=Math.max(0,e)}canJump(){return this._canJump}setCanJump(){this._canJump=!0}setCanNotAirJump(){(this.isJumping()||this.isFalling())&&(this._canJump=!1)}abortJump(){this.isJumping()&&(this._currentFallSpeed=0,this._currentJumpSpeed=0)}simulateForwardKey(){this._hasPressedForwardKey=!0}wasForwardKeyPressed(){return this._wasForwardKeyPressed}simulateBackwardKey(){this._hasPressedBackwardKey=!0}wasBackwardKeyPressed(){return this._wasBackwardKeyPressed}simulateRightKey(){this._hasPressedRightKey=!0}wasRightKeyPressed(){return this._wasRightKeyPressed}simulateLeftKey(){this._hasPressedLeftKey=!0}wasLeftKeyPressed(){return this._wasLeftKeyPressed}simulateJumpKey(){this._hasPressedJumpKey=!0}wasJumpKeyPressed(){return this._wasJumpKeyPressed}simulateStick(e,t){this._hasUsedStick=!0,this._stickAngle=e,this._stickForce=Math.max(0,Math.min(1,t))}wasStickUsed(){return this._wasStickUsed}getStickAngle(){return this._wasStickUsed?this._stickAngle:0}getStickForce(){return this._wasStickUsed?this._stickForce:0}isOnFloor(){return this.character?this.character.IsSupported()&&this.character.GetGroundNormal().GetZ()>=this._slopeClimbingMinNormalZ&&this._currentJumpSpeed<=this._currentFallSpeed:!1}isOnFloorObject(e){return!e._body||!this.character||!this.isOnFloor()?!1:this.character.GetGroundBodyID().GetIndexAndSequenceNumber()===e._body.GetID().GetIndexAndSequenceNumber()}isJumping(){return this._currentJumpSpeed>0}isFallingWithoutJumping(){return!this.isOnFloor()&&!this.isJumping()}isFalling(){return this.isFallingWithoutJumping()||this.isJumping()&&this._currentFallSpeed>this._currentJumpSpeed}isMovingEvenALittle(){return this._hasReallyMoved&&(this._currentForwardSpeed!==0||this._currentSidewaysSpeed!==0)||this._currentJumpSpeed!==0||this._currentFallSpeed!==0}getJumpSpeedToReach(e){e=-Math.abs(e);const t=this._gravity,s=this._maxFallingSpeed,o=this._jumpSustainTime,a=s/t,r=n=>Math.sqrt(-n*t*2),i=n=>-t*o+s+Math.sqrt(t*t*o*o-2*n*t-s*s);let h=0,c=0;return a>o?(h=-t*o+Math.sqrt(2*t*t*o*o-4*e*t),c=(t*o+h)/(2*t),c<o?h=r(e):c>a&&(h=i(e))):(h=r(e),c=h/t,c>a&&(h=i(e))),h}};let b=v;b.epsilon=2**-20,l.PhysicsCharacter3DRuntimeBehavior=b,l.registerBehavior("Physics3D::PhysicsCharacter3D",l.PhysicsCharacter3DRuntimeBehavior),function(s){class j{constructor(a){this.characterVsCharacterCollision=new Jolt.CharacterVsCharacterCollisionSimple}static getManager(a){return a.charactersManager||(a.charactersManager=new l.PhysicsCharacter3DRuntimeBehavior.CharactersManager(a)),a.charactersManager}addCharacter(a){this.characterVsCharacterCollision.Add(a),a.SetCharacterVsCharacterCollision(this.characterVsCharacterCollision)}removeCharacter(a){this.characterVsCharacterCollision.Remove(a)}destroy(){Jolt.destroy(this.characterVsCharacterCollision)}}s.CharactersManager=j,l.registerRuntimeSceneUnloadedCallback(function(o){l.PhysicsCharacter3DRuntimeBehavior.CharactersManager.getManager(o).destroy()});class e{constructor(a){this.characterBehavior=a}createAndAddBody(){const a=this.characterBehavior.getPhysics3D();if(!a)return null;const{behavior:r}=a,{_slopeMaxAngle:i,owner3D:h,_sharedData:c}=this.characterBehavior,n=r.createShapeWithoutMassCenterOffset(),d=new Jolt.CharacterVirtualSettings;d.mInnerBodyLayer=this.characterBehavior._canBePushed?0:r.getBodyLayer(),d.mInnerBodyShape=n,d.mMass=n.GetMassProperties().get_mMass(),d.mMaxSlopeAngle=l.toRad(i),d.mShape=n,d.mUp=Jolt.Vec3.prototype.sAxisZ(),d.mBackFaceMode=Jolt.EBackFaceMode_CollideWithBackFaces;const C=h.getDepth()*c.worldInvScale,m=h.getWidth()*c.worldInvScale,F=h.getHeight()*c.worldInvScale,M=C/2,A=Math.sqrt(m*F)/2;d.mSupportingVolume=new Jolt.Plane(Jolt.Vec3.prototype.sAxisZ(),M-A*(1-Math.cos(l.toRad(Math.min(i+20,70)))));const g=new Jolt.CharacterVirtual(d,this.characterBehavior._getPhysicsPosition(c.getRVec3(0,0,0)),r._getPhysicsRotation(c.getQuat(0,0,0,1)),c.physicsSystem);Jolt.destroy(d);const P=c.physicsSystem.GetBodyLockInterface().TryGetBody(g.GetInnerBodyID());if(this.characterBehavior.character&&(this.characterBehavior._canBePushed&&(this.characterBehavior.charactersManager.removeCharacter(this.characterBehavior.character),Jolt.destroy(this.characterBehavior.character.GetListener())),Jolt.destroy(this.characterBehavior.character)),this.characterBehavior.character=g,this.characterBehavior._canBePushed){this.characterBehavior.charactersManager.addCharacter(g);const u=new Jolt.CharacterContactListenerJS;u.OnAdjustBodyVelocity=(y,_,S,w)=>{},u.OnContactValidate=(y,_,S)=>!0,u.OnCharacterContactValidate=(y,_,S)=>{const w=Jolt.wrapPointer(y,Jolt.CharacterVirtual),p=Jolt.wrapPointer(_,Jolt.CharacterVirtual),f=c.physicsSystem.GetBodyLockInterface().TryGetBody(w.GetInnerBodyID()),D=c.physicsSystem.GetBodyLockInterface().TryGetBody(p.GetInnerBodyID()),B=f.gdjsAssociatedBehavior,J=D.gdjsAssociatedBehavior;return!B||!J?!0:B.canCollideAgainst(J)},u.OnContactAdded=(y,_,S,w,p,f)=>{},u.OnContactPersisted=(y,_,S,w,p,f)=>{},u.OnContactRemoved=(y,_,S)=>{},u.OnCharacterContactAdded=(y,_,S,w,p,f)=>{},u.OnCharacterContactPersisted=(y,_,S,w,p,f)=>{},u.OnCharacterContactRemoved=(y,_,S)=>{},u.OnContactSolve=(y,_,S,w,p,f,D,B,J)=>{},u.OnCharacterContactSolve=(y,_,S,w,p,f,D,B,J)=>{},g.SetListener(u)}return P}updateObjectFromBody(){const{character:a}=this.characterBehavior;!a||(this.characterBehavior._moveObjectToPhysicsPosition(a.GetPosition()),this.characterBehavior._moveObjectToPhysicsRotation(a.GetRotation()))}updateBodyFromObject(){const a=this.characterBehavior.getPhysics3D();if(!a)return;const{behavior:r}=a,{character:i,owner3D:h,_sharedData:c}=this.characterBehavior;!i||((r._objectOldX!==h.getX()||r._objectOldY!==h.getY()||r._objectOldZ!==h.getZ())&&this.updateCharacterPosition(),(r._objectOldRotationX!==h.getRotationX()||r._objectOldRotationY!==h.getRotationY()||r._objectOldRotationZ!==h.getAngle())&&i.SetRotation(this.characterBehavior._getPhysicsRotation(c.getQuat(0,0,0,1))))}updateCharacterPosition(){const{character:a,_sharedData:r}=this.characterBehavior;!a||a.SetPosition(this.characterBehavior._getPhysicsPosition(r.getRVec3(0,0,0)))}recreateShape(){const a=this.characterBehavior.getPhysics3D();if(!a)return;const{behavior:r,broadPhaseLayerFilter:i,objectLayerFilter:h,bodyFilter:c,shapeFilter:n}=a,{character:d,_sharedData:C}=this.characterBehavior;if(!d)return;const m=r.createShapeWithoutMassCenterOffset();!d.SetShape(m,Number.MAX_VALUE,i,h,c,n,C.jolt.GetTempAllocator())||(d.SetInnerBodyShape(m),d.SetMass(m.GetMassProperties().get_mMass()),this.updateCharacterPosition())}destroyBody(){this.characterBehavior._destroyBody()}}s.CharacterBodyUpdater=e;class t{constructor(a){this._currentContacts=[];this._previousContacts=[];this.characterBehavior=a}clearContacts(){this._previousContacts.length=0,this._currentContacts.length=0}updateContacts(){const a=this._previousContacts;this._previousContacts=this._currentContacts,this._currentContacts=a,this._currentContacts.length=0;const{character:r,_sharedData:i}=this.characterBehavior;if(!r)return;const h=r.GetActiveContacts();for(let c=0;c<h.size();c++){const n=h.at(c),m=i.physicsSystem.GetBodyLockInterface().TryGetBody(n.mBodyB).gdjsAssociatedBehavior;m&&this._currentContacts.push(m)}}isColliding(a){const{character:r}=this.characterBehavior;return r?this._currentContacts.some(i=>i.owner===a):!1}hasCollisionStartedWith(a){const{character:r}=this.characterBehavior;return r?this._currentContacts.some(i=>i.owner===a)&&!this._previousContacts.some(i=>i.owner===a):!1}hasCollisionStoppedWith(a){const{character:r}=this.characterBehavior;return r?!this._currentContacts.some(i=>i.owner===a)&&this._previousContacts.some(i=>i.owner===a):!1}}s.CharacterCollisionChecker=t}(b=l.PhysicsCharacter3DRuntimeBehavior||(l.PhysicsCharacter3DRuntimeBehavior={}))})(gdjs||(gdjs={}));
//# sourceMappingURL=PhysicsCharacter3DRuntimeBehavior.js.map
